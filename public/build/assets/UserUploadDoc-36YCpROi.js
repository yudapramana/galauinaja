import{_ as re,C as de,e as r,x as z,u as ue,f as ce,c as i,o as n,a,N as G,p as v,i as A,v as J,F as k,G as j,t as u,h as K,k as V,d as h,M as pe,n as B,U as O,q as I}from"./app-BWoptFV_.js";import{S as C}from"./sweetalert2.esm.all-9Qm2jZ7z.js";import{u as me}from"./MasterDataStore-hCAQVJqd.js";import{_ as ve,L as fe}from"./PreviewModal-DW0FQ7fM.js";import"./LoadingStore-BQsd_xXe.js";const _e={class:"content"},ge={class:"container-fluid"},be={class:"card shadow-sm rounded-lg"},he={class:"card-body p-3"},ye={class:"input-group mb-3"},ke={class:"input-group-append"},we=["disabled"],xe={key:0,class:"fa fa-spinner fa-spin mr-1"},De={key:1,class:"fas fa-sync"},Ue={key:1,class:"tree"},Ce={class:"list-unstyled mb-0"},Fe={class:"d-flex align-items-center justify-between cursor-pointer py-1 px-2 bg-light rounded small"},Se=["onClick"],Pe={class:"ml-2 font-weight-bold"},Me={class:"text-warning"},Le={class:"badge badge-pill badge-primary ml-2"},Ae={key:0,type:"button",class:"btn btn-warning btn-sm ml-2",disabled:""},Be=["onClick"],Te={class:"pl-4 mt-1"},$e={class:"d-flex align-items-center justify-content-between w-100"},Ne={class:"d-flex align-items-center"},je=["onClick"],Ve={key:0,class:"badge badge-sm badge-warning ml-2",disabled:""},Ie=["onClick"],qe={key:0,class:"text-danger mt-1 ml-4 small"},Ee={key:0,class:"text-muted small ml-4 mt-1"},Re={key:2,class:"text-center p-5"},ze={key:1,class:"modal fade show",style:{display:"block"},tabindex:"-1","aria-modal":"true"},Ge={class:"modal-dialog modal-lg modal-dialog-scrollable"},Je={class:"modal-content",style:{"max-height":"90vh",display:"flex","flex-direction":"column"}},Ke={class:"modal-header"},Oe={class:"modal-title"},He={class:"modal-body overflow-auto",style:{flex:"1 1 auto"}},Qe=["value"],We={class:"form-group"},Xe=["value"],Ye={key:0,class:"form-group"},Ze={class:"btn-group mb-2 flex-wrap"},ea=["onClick"],aa={class:"input-group mb-3"},ta={class:"input-group-append"},la={class:"form-group"},sa={key:0,class:"mb-2"},oa=["href"],na={class:"custom-file"},ia=["required"],ra={class:"custom-file-label",for:"fileInput"},da={key:1,class:"mb-3"},ua={class:"progress",style:{height:"20px"}},ca=["aria-valuenow"],pa={class:"modal-footer"},ma=["disabled"],va={key:0},fa={key:1},_a={__name:"UserUploadDoc",setup(ga){const F=de();F.setting.maintenance=["1",1,!0,"true","on"].includes(F.setting.maintenance);const S=r([]),w=r(null),x=r(""),p=r(!1),P=r(null),M=r([]),T=r(!1),g=r(!1),D=r(""),$=r(!1),L=r(!1),b=r(null),U=r(!1),f=r(0),H=z(()=>f.value<30?"bg-danger":f.value<70?"bg-warning":"bg-success");r(null);const _=r(!1),Q=t=>{switch(t){case"Approved":return"badge-success";case"Rejected":return"badge-danger";default:return"badge-secondary"}},N=me(),m=ue(),o=r({doc_number:"",doc_date:"",parameter:"",file:null,fileName:"",file_id:null}),W=async t=>{T.value=!0;try{const e=await I.get(`/api/document-log/${t}`);M.value=e.data.data||[]}catch(e){m.handleAuthError(e),M.value=[]}finally{T.value=!1}},q=async()=>{console.log("eh kepanggil fetchdata didalam"),p.value=!0,await N.getDoctypeList(),await m.getMyDocuments();const t=N.doctypeList,e=m.myDocuments;S.value=t.map(s=>{const c=e.filter(l=>l.id_doc_type===s.id||l.doc_type_id===s.id||l.doc_type===s.id).sort((l,y)=>l.file_name.localeCompare(y.file_name));return console.log("doctype.text"),console.log(s.text),{id:s.id,text:s.text,mandatory:s.mandatory,multiple:s.multiple,expanded:!0,files:c.map(l=>({...l,doc_type_text:s.text}))}}),p.value=!1},X=t=>{t.expanded=!t.expanded},Y=t=>`/api/preview/pdf?path=${encodeURI(t)}`,Z=async t=>{if(console.log("file"),console.log(t),$.value=t.status==="Approved",t.status=="Approved"){_.value=!1,P.value=t,$.value=t.status==="Approved";const e=t==null?void 0:t.file_path;if(!e){_.value=!0;return}w.value=Y(e)}else{_.value=!1,P.value=t,w.value=t.file_url;try{const e=await fetch(t.file_url,{method:"HEAD"});if(!e.ok){e.status===404?_.value="not_found":_.value=!0;return}const s=e.headers.get("content-type");(!s||!s.includes("pdf"))&&(_.value=!0)}catch{_.value=!0}}await W(t.id)},ee=()=>{x.value=""},ae=async()=>{p.value=!0,await m.syncFiles(),await m.getDocsUpdateState(),console.log("eh kepanggil fetchdata didalam onMounted Doclist"),await q(),p.value=!1},E=z(()=>{if(!x.value)return S.value;const t=x.value.toLowerCase();return S.value.filter(e=>e.text.toLowerCase().includes(t)||e.files.some(s=>s.file_name.toLowerCase().includes(t)))}),te=t=>{b.value=t,g.value=!1,D.value="",L.value=!0,o.value={doc_number:"",doc_date:"",parameter:"",file:null}},R=()=>{L.value=!1,g.value=!1,o.value={doc_number:"",doc_date:"",parameter:"",file:null,file_id:null},D.value=""},le=t=>{const e=t.target.files[0];if(e&&(o.value.file=e,o.value.fileName=e.name),!e){o.value.file=null,o.value.fileName="";return}if(e.type!=="application/pdf"){C.fire({icon:"error",title:"Format Salah",text:"File harus berformat PDF!"}),t.target.value="",o.value.file=null;return}const s=1*1024*1024;if(e.size>s){C.fire({icon:"error",title:"Ukuran File Terlalu Besar",text:"Ukuran maksimal file adalah 1MB!"}),t.target.value="",o.value.file=null;return}o.value.file=e,o.value.fileName=e.name},se=(t,e)=>{b.value=e,L.value=!0,g.value=!0,D.value=t.file_url||"",o.value={doc_number:t.doc_number||"",doc_date:t.doc_date||"",parameter:t.parameter||"",file:null,file_id:t.id},console.log("uploadForm"),console.log(o)},oe=async()=>{var e;if(console.log("uploadForm on BUTTON SUBMIT"),console.log(o),!o.value.file&&!o.value.file_id){C.fire({icon:"warning",title:"File Belum Dipilih",text:"Silakan pilih file terlebih dahulu."});return}U.value=!0;const t=new FormData;t.append("doc_number",o.value.doc_number),t.append("doc_date",o.value.doc_date),t.append("parameter",o.value.parameter),o.value.file&&t.append("file",o.value.file),t.append("id_doc_type",b.value.id);try{o.value.file_id?await I.post(`/api/reupload-document/${o.value.file_id}`,t,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:s=>{s.total&&(f.value=Math.round(s.loaded*100/s.total))}}):await I.post("/api/upload-document",t,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:s=>{s.total&&(f.value=Math.round(s.loaded*100/s.total))}}),C.fire({icon:"success",title:o.value.file_id?"Dokumen berhasil diperbarui. Perubahan akan tampil dalam 1â€“2 menit, mohon tunggu sebentar.":"Dokumen berhasil diupload. Perubahan akan tampil dalam 1â€“2 menit, mohon tunggu sebentar.",showConfirmButton:!1,timer:2e3}),await ne(b.value.id),R()}catch(s){let c="Terjadi kesalahan saat mengupload file.";if(((e=s.response)==null?void 0:e.status)===422&&s.response.data.errors){const l=s.response.data.errors;c=Object.values(l).flat().join(`
`)}C.fire({icon:"error",title:"Upload Gagal",text:c})}finally{U.value=!1,f.value=0}},ne=async t=>{m.docsUpdateState=!0,await m.getMyDocuments();const s=m.myDocuments.filter(l=>l.id_doc_type===t||l.doc_type_id===t||l.doc_type===t).sort((l,y)=>l.file_name.localeCompare(y.file_name)),c=S.value.find(l=>l.id===t);c&&(c.files=s)};return ce(async()=>{p.value=!0,await m.getDocsUpdateState(),console.log("eh kepanggil fetchdata didalam onMounted Doclist"),await q(),p.value=!1}),(t,e)=>{var s,c;return n(),i(k,null,[e[18]||(e[18]=a("section",{class:"content-header"},[a("div",{class:"container-fluid"},[a("h3",{class:"text-primary"},"ðŸ“‚ Upload Dokumen")])],-1)),a("section",_e,[a("div",ge,[a("div",be,[a("div",he,[a("div",ye,[A(a("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=l=>x.value=l),class:"form-control",placeholder:"Cari dokumen..."},null,512),[[J,x.value]]),a("div",ke,[a("button",{disabled:p.value,class:"btn btn-outline-secondary",type:"button",onClick:ae},[p.value?(n(),i("i",xe)):(n(),i("i",De))],8,we),a("button",{class:"btn btn-outline-secondary",type:"button",onClick:ee},"Reset")])]),p.value?(n(),G(fe,{key:0})):E.value.length?(n(),i("div",Ue,[a("ul",Ce,[(n(!0),i(k,null,j(E.value,(l,y)=>(n(),i("li",{key:l.id,class:"mb-2"},[a("div",Fe,[a("div",{onClick:d=>X(l),class:"flex-grow-1 d-flex align-items-center"},[a("i",{class:B([l.expanded?"fas fa-folder-open text-warning":"fas fa-folder text-secondary","mr-2"])},null,2),a("span",Pe,[h(u(y+1)+". "+u(l.text)+" ",1),A(a("span",Me,"*",512),[[O,l.mandatory==1]]),a("span",Le,u(l.files.length),1)])],8,Se),V(F).showMaintenanceBadge?(n(),i("button",Ae,"Fitur Maintenance")):(n(),i("button",{key:1,class:"btn btn-sm btn-success ml-2",onClick:d=>te(l)},"+ Upload",8,Be))]),A(a("ul",Te,[(n(!0),i(k,null,j(l.files,d=>(n(),i("li",{key:d.id,class:"cursor-pointer p-1 rounded hover-bg-light small"},[a("div",$e,[a("div",Ne,[e[5]||(e[5]=a("i",{class:"fas fa-file-pdf text-danger mr-2"},null,-1)),a("span",{onClick:ie=>Z(d)},u(d.file_name),9,je),a("span",{class:B(["badge badge-sm ml-2",Q(d.status)])},u(d.status||"Pending"),3),V(F).showMaintenanceBadge?(n(),i(k,{key:0},[d.status!=="Approved"?(n(),i("span",Ve," Maintenance ")):v("",!0)],64)):(n(),i(k,{key:1},[d.status!=="Approved"?(n(),i("span",{key:0,class:"badge badge-sm badge-primary ml-2",onClick:ie=>se(d,l)}," Perbarui ",8,Ie)):v("",!0)],64))])]),d.status==="Rejected"&&d.verif_notes?(n(),i("div",qe,[e[6]||(e[6]=a("i",{class:"fas fa-info-circle"},null,-1)),h(" Catatan: "+u(d.verif_notes),1)])):v("",!0)]))),128)),l.files.length?v("",!0):(n(),i("li",Ee," Tidak ada file diupload. "))],512),[[O,l.expanded]])]))),128))])])):(n(),i("div",Re,e[7]||(e[7]=[a("span",{class:"text-muted"},"Data tidak ditemukan.",-1)])))])])])]),w.value?(n(),G(ve,{key:0,"preview-url":w.value,"selected-preview-file":P.value,"is-loading-verval":T.value,vervalLogs:M.value,pdfError:_.value,isApprovedPreview:$.value,onClose:e[1]||(e[1]=l=>{w.value=null,P.value=null,M.value=[]})},null,8,["preview-url","selected-preview-file","is-loading-verval","vervalLogs","pdfError","isApprovedPreview"])):v("",!0),L.value?(n(),i("div",ze,[a("div",Ge,[a("div",Je,[a("div",Ke,[a("h5",Oe,u(g.value?"Edit Dokumen Pegawai":"Upload Dokumen Pegawai"),1),a("button",{type:"button",class:"close",onClick:R},e[8]||(e[8]=[a("span",null,"Ã—",-1)]))]),a("div",He,[a("form",{onSubmit:K(oe,["prevent"]),id:"uploadForm"},[a("input",{type:"hidden",value:(s=b.value)==null?void 0:s.id},null,8,Qe),a("div",We,[e[9]||(e[9]=a("label",null,"Tipe Dokumen",-1)),a("input",{type:"text",class:"form-control",value:(c=b.value)==null?void 0:c.text,readonly:""},null,8,Xe)]),b.value.multiple==1?(n(),i("div",Ye,[e[10]||(e[10]=a("label",null,"Pilih Parameter",-1)),e[11]||(e[11]=a("br",null,null,-1)),a("div",Ze,[(n(!0),i(k,null,j(V(N).docParameters,l=>(n(),i("button",{key:l,type:"button",class:B(["btn btn-xs btn-outline-secondary mb-1",{active:o.value.parameter===l}]),onClick:y=>o.value.parameter=l},u(l),11,ea))),128))]),a("div",aa,[A(a("input",{"onUpdate:modelValue":e[2]||(e[2]=l=>o.value.parameter=l),type:"text",class:"form-control",required:"",onKeydown:e[3]||(e[3]=K(()=>{},["prevent"])),placeholder:"Pilih parameter dari tombol di atas",readonly:""},null,544),[[J,o.value.parameter]]),a("div",ta,[a("button",{type:"button",class:"btn btn-info",onClick:e[4]||(e[4]=l=>o.value.parameter="")},"Reset")])]),e[12]||(e[12]=a("small",{class:"form-text text-muted mb-2"},[a("strong",null,"Info:"),h(" Gunakan parameter jika dokumen ini bisa lebih dari satu, seperti "),a("em",null,"Akte Anak"),h(", "),a("em",null,"SK Jabatan"),h(", dst. ")],-1))])):v("",!0),a("div",la,[e[16]||(e[16]=a("label",null,"File Dokumen (PDF)",-1)),g.value&&D.value?(n(),i("div",sa,[a("a",{href:D.value,target:"_blank",class:"btn btn-sm btn-outline-primary"},e[13]||(e[13]=[a("i",{class:"fas fa-file-pdf"},null,-1),h(" Lihat Dokumen Lama ")]),8,oa),e[14]||(e[14]=a("br",null,null,-1)),e[15]||(e[15]=a("small",{class:"text-muted"},"Jika tidak ingin mengganti file, biarkan kosong.",-1))])):v("",!0),a("div",na,[a("input",{type:"file",class:"custom-file-input",id:"fileInput",accept:"application/pdf",onChange:le,required:!g.value},null,40,ia),a("label",ra,u(o.value.fileName||"Pilih file"),1)])]),U.value?(n(),i("div",da,[a("div",ua,[a("div",{class:B(["progress-bar progress-bar-striped progress-bar-animated",H.value]),role:"progressbar",style:pe({width:f.value+"%"}),"aria-valuenow":f.value,"aria-valuemin":"0","aria-valuemax":"100"},u(f.value)+"% ",15,ca)])])):v("",!0)],32)]),a("div",pa,[a("button",{type:"submit",class:"btn btn-primary",disabled:U.value,form:"uploadForm"},[U.value?(n(),i("span",va,e[17]||(e[17]=[a("i",{class:"fas fa-spinner fa-spin"},null,-1),h(" Uploading... ")]))):(n(),i("span",fa,u(g.value?"Simpan Perubahan":"Upload"),1))],8,ma)])])])])):v("",!0)],64)}}},xa=re(_a,[["__scopeId","data-v-730de9c0"]]);export{xa as default};
