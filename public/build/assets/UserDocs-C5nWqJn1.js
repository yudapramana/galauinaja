import{_ as Y,u as me,e as i,x as H,f as Z,D as ve,c as r,o as n,a,N as R,p as g,d as p,t as u,i as L,v as Q,F as A,G as E,n as M,U as W,h as X,k as fe,M as _e,m as be,q as $,s as ge}from"./app-EcdR99ZA.js";import{S as T}from"./sweetalert2.esm.all-9Qm2jZ7z.js";import{u as he}from"./MasterDataStore-LtJTufP8.js";import{L as ye,_ as ke}from"./PreviewModal-DJ2zo1Dv.js";import"./LoadingStore-VhaRo9Pf.js";const we={class:"content-header"},xe={class:"container-fluid"},De={class:"text-primary"},Ce={class:"text-muted text-sm"},Ue={class:"content"},Pe={class:"container-fluid"},Fe={class:"card shadow-sm rounded-lg"},Ie={class:"card-body p-3"},Se={class:"input-group mb-3"},Le={class:"input-group-append"},Ae=["disabled"],Me={key:0,class:"fa fa-spinner fa-spin mr-1"},$e={key:1,class:"fas fa-sync"},Te={key:1,class:"tree"},Be={class:"list-unstyled mb-0"},Ne={class:"d-flex align-items-center justify-between cursor-pointer py-1 px-2 bg-light rounded small"},Ve=["onClick"],je={class:"ml-2 font-weight-bold"},Ee={class:"text-warning"},Re={class:"badge badge-pill badge-primary ml-2"},qe=["onClick"],Ke={class:"pl-4 mt-1"},ze={class:"d-flex align-items-center justify-content-between w-100"},Ge={class:"d-flex align-items-center"},Je=["onClick"],Oe=["onClick"],He={key:0,class:"text-danger mt-1 ml-4 small"},Qe={key:0,class:"text-muted small ml-4 mt-1"},We={key:2,class:"text-center p-5"},Xe={key:1,class:"modal fade show",style:{display:"block"},tabindex:"-1","aria-modal":"true"},Ye={class:"modal-dialog modal-lg modal-dialog-scrollable"},Ze={class:"modal-content",style:{"max-height":"90vh",display:"flex","flex-direction":"column"}},ea={class:"modal-header"},aa={class:"modal-title"},ta={class:"modal-body overflow-auto",style:{flex:"1 1 auto"}},sa=["value"],la={class:"form-group"},oa=["value"],na={class:"form-group"},ra={class:"btn-group mb-2 flex-wrap"},ia=["onClick"],da={class:"input-group mb-3"},ua={class:"input-group-append"},ca={class:"form-group"},pa={key:0,class:"mb-2"},ma=["href"],va={class:"custom-file"},fa=["required"],_a={class:"custom-file-label",for:"fileInput"},ba={key:0,class:"mb-3"},ga={class:"progress",style:{height:"20px"}},ha=["aria-valuenow"],ya={class:"modal-footer"},ka=["disabled"],wa={key:0},xa={key:1},Da={__name:"AdminDocumentViewer",props:{userId:Number},setup(q){const k=me(),C=be(),K=()=>{C.back()},f=q,U=i([]),w=i(null),P=i(""),_=i(!1),F=i(null),I=i(!1),h=i(null),x=i(!1),m=i(0),z=i(""),S=i([]),B=i(!1),b=i(!1),D=i(""),N=i(!1);i(null);const v=i(!1),o=i({doc_number:"",doc_date:"",parameter:"",file:null,fileName:"",file_id:null}),V=he(),G=async t=>{const e=await $.get(`/api/user-documents/${t}`);return z.value=e.data.user.name,e.data.data},j=async()=>{_.value=!0,await V.getDoctypeList(f.userId);const t=await G(f.userId),e=V.doctypeList;U.value=e.map(l=>{const c=t.filter(s=>s.id_doc_type===l.id||s.doc_type_id===l.id||s.doc_type===l.id).sort((s,y)=>s.file_name.localeCompare(y.file_name));return{id:l.id,text:l.text,mandatory:l.mandatory,multiple:l.multiple,expanded:!0,files:c.map(s=>({...s,doc_type_text:l.text}))}}),_.value=!1},ee=async t=>{const l=(await G(f.userId)).filter(s=>s.id_doc_type===t||s.doc_type_id===t||s.doc_type===t).sort((s,y)=>s.file_name.localeCompare(y.file_name)),c=U.value.find(s=>s.id===t);c&&(c.files=l)},ae=H(()=>m.value<30?"bg-danger":m.value<70?"bg-warning":"bg-success"),J=H(()=>{if(!P.value)return U.value;const t=P.value.toLowerCase();return U.value.filter(e=>e.text.toLowerCase().includes(t)||e.files.some(l=>l.file_name.toLowerCase().includes(t)))}),te=t=>{switch(t){case"Approved":return"badge-success";case"Rejected":return"badge-danger";default:return"badge-secondary"}},se=t=>{t.expanded=!t.expanded},le=async t=>{B.value=!0;try{const e=await $.get(`/api/document-log/${t}`);S.value=e.data.data||[]}catch(e){k.handleAuthError(e),S.value=[]}finally{B.value=!1}},oe=t=>`/api/preview/pdf?path=${encodeURI(t)}`,ne=async t=>{if(console.log("file"),console.log(t),N.value=t.status==="Approved",t.status=="Approved"){v.value=!1,F.value=t,N.value=t.status==="Approved";const e=t==null?void 0:t.file_path;if(!e){v.value=!0;return}w.value=oe(e)}else{v.value=!1,F.value=t,w.value=t.file_url;try{const e=await fetch(t.file_url,{method:"HEAD"});if(!e.ok){e.status===404?v.value="not_found":v.value=!0;return}const l=e.headers.get("content-type");(!l||!l.includes("pdf"))&&(v.value=!0)}catch{v.value=!0}}await le(t.id)},re=async()=>{_.value=!0,await k.syncFilesIndividual(f.userId),await k.getDocsUpdateState(),console.log("eh kepanggil fetchdata didalam onMounted Doclist"),await j(),_.value=!1},ie=t=>{h.value=t,b.value=!1,D.value="",I.value=!0,o.value={doc_number:"",doc_date:"",parameter:"",file:null,file_id:null}},de=(t,e)=>{h.value=e,I.value=!0,b.value=!0,D.value=t.file_url||"",o.value={doc_number:t.doc_number||"",doc_date:t.doc_date||"",parameter:t.parameter||"",file:null,file_id:t.id},console.log("uploadForm"),console.log(o)},O=()=>{I.value=!1,b.value=!1,o.value={doc_number:"",doc_date:"",parameter:"",file:null,file_id:null},D.value=""},ue=t=>{const e=t.target.files[0];if(!e||e.type!=="application/pdf"||e.size>1024*1024){T.fire({icon:"error",title:"File Tidak Valid",text:"File harus PDF dan ukuran maksimal 1MB."}),t.target.value="",o.value.fileName="";return}o.value.file=e,o.value.fileName=e.name},ce=async()=>{var e;if(!o.value.file&&!o.value.file_id)return T.fire({icon:"warning",title:"File Belum Dipilih"});x.value=!0;const t=new FormData;t.append("doc_number",o.value.doc_number),t.append("doc_date",o.value.doc_date),t.append("parameter",o.value.parameter),o.value.file&&t.append("file",o.value.file),t.append("id_doc_type",h.value.id),t.append("user_id",f.userId);try{o.value.file_id?await $.post(`/api/reupload-document/${o.value.file_id}`,t,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:l=>{l.total&&(m.value=Math.round(l.loaded*100/l.total))}}):await $.post("/api/upload-document",t,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:l=>{l.total&&(m.value=Math.round(l.loaded*100/l.total))}}),T.fire({icon:"success",title:o.value.file_id?"Dokumen berhasil diperbarui. Perubahan akan tampil dalam 1â€“2 menit, mohon tunggu sebentar.":"Dokumen berhasil diupload. Perubahan akan tampil dalam 1â€“2 menit, mohon tunggu sebentar.",showConfirmButton:!1,timer:2e3}),await ee(h.value.id),O()}catch(l){let c="Terjadi kesalahan saat mengupload file.";if(((e=l.response)==null?void 0:e.status)===422&&l.response.data.errors){const s=l.response.data.errors;c=Object.values(s).flat().join(`
`)}T.fire({icon:"error",title:"Upload Gagal",text:c})}finally{x.value=!1,m.value=0}};return Z(j),ve(()=>f.userId,j),(t,e)=>{var l,c;return n(),r(A,null,[a("section",we,[a("div",xe,[a("h3",De,[e[6]||(e[6]=p("ðŸ“‚ Dokumen ")),a("small",Ce,u(z.value),1)]),a("button",{class:"btn btn-sm btn-secondary mt-2",onClick:K},e[7]||(e[7]=[a("i",{class:"fas fa-arrow-left mr-1"},null,-1),p(" Kembali ")]))])]),a("section",Ue,[a("div",Pe,[a("div",Fe,[a("div",Ie,[a("div",Se,[L(a("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=s=>P.value=s),class:"form-control",placeholder:"Cari dokumen..."},null,512),[[Q,P.value]]),a("div",Le,[a("button",{disabled:_.value,class:"btn btn-outline-secondary",type:"button",onClick:re},[_.value?(n(),r("i",Me)):(n(),r("i",$e))],8,Ae),a("button",{class:"btn btn-outline-secondary",type:"button",onClick:e[1]||(e[1]=(...s)=>t.clearSearch&&t.clearSearch(...s))},"Reset")])]),_.value?(n(),R(ye,{key:0})):J.value.length?(n(),r("div",Te,[a("ul",Be,[(n(!0),r(A,null,E(J.value,(s,y)=>(n(),r("li",{key:s.id,class:"mb-2"},[a("div",Ne,[a("div",{onClick:d=>se(s),class:"flex-grow-1 d-flex align-items-center"},[a("i",{class:M([s.expanded?"fas fa-folder-open text-warning":"fas fa-folder text-secondary","mr-2"])},null,2),a("span",je,[p(u(y+1)+". "+u(s.text)+" ",1),L(a("span",Ee,"*",512),[[W,s.mandatory==1]]),a("span",Re,u(s.files.length),1)])],8,Ve),a("button",{class:"btn btn-sm btn-success ml-2",onClick:d=>ie(s)},"+ Upload",8,qe)]),L(a("ul",Ke,[(n(!0),r(A,null,E(s.files,d=>(n(),r("li",{key:d.id,class:"cursor-pointer p-1 rounded hover-bg-light small"},[a("div",ze,[a("div",Ge,[e[8]||(e[8]=a("i",{class:"fas fa-file-pdf text-danger mr-2"},null,-1)),a("span",{onClick:pe=>ne(d)},u(d.file_name),9,Je),a("span",{class:M(["badge badge-sm ml-2",te(d.status)])},u(d.status||"Pending"),3),d.status!=="Approved"?(n(),r("span",{key:0,class:"badge badge-sm badge-primary ml-2",onClick:pe=>de(d,s)}," Perbarui ",8,Oe)):g("",!0)])]),d.status==="Rejected"&&d.verif_notes?(n(),r("div",He,[e[9]||(e[9]=a("i",{class:"fas fa-info-circle"},null,-1)),p(" Catatan: "+u(d.verif_notes),1)])):g("",!0)]))),128)),s.files.length?g("",!0):(n(),r("li",Qe," Tidak ada file diupload. "))],512),[[W,s.expanded]])]))),128))])])):(n(),r("div",We,e[10]||(e[10]=[a("span",{class:"text-muted"},"Data tidak ditemukan.",-1)])))])])])]),w.value?(n(),R(ke,{key:0,"preview-url":w.value,"selected-preview-file":F.value,"is-loading-verval":B.value,vervalLogs:S.value,pdfError:v.value,isApprovedPreview:N.value,onClose:e[2]||(e[2]=s=>{w.value=null,F.value=null,S.value=[]})},null,8,["preview-url","selected-preview-file","is-loading-verval","vervalLogs","pdfError","isApprovedPreview"])):g("",!0),I.value?(n(),r("div",Xe,[a("div",Ye,[a("div",Ze,[a("div",ea,[a("h5",aa,u(b.value?"Edit Dokumen Pegawai":"Upload Dokumen Pegawai"),1),a("button",{type:"button",class:"close",onClick:O},e[11]||(e[11]=[a("span",null,"Ã—",-1)]))]),a("div",ta,[a("form",{onSubmit:X(ce,["prevent"]),id:"uploadForm"},[a("input",{type:"hidden",value:(l=h.value)==null?void 0:l.id},null,8,sa),a("div",la,[e[12]||(e[12]=a("label",null,"Tipe Dokumen",-1)),a("input",{type:"text",class:"form-control",value:(c=h.value)==null?void 0:c.text,readonly:""},null,8,oa)]),a("div",na,[e[13]||(e[13]=a("label",null,"Pilih Parameter (Opsional)",-1)),e[14]||(e[14]=a("br",null,null,-1)),a("div",ra,[(n(!0),r(A,null,E(fe(V).docParameters,s=>(n(),r("button",{key:s,type:"button",class:M(["btn btn-xs btn-outline-secondary mb-1",{active:o.value.parameter===s}]),onClick:y=>o.value.parameter=s},u(s),11,ia))),128))]),a("div",da,[L(a("input",{"onUpdate:modelValue":e[3]||(e[3]=s=>o.value.parameter=s),type:"text",class:"form-control",required:"",onKeydown:e[4]||(e[4]=X(()=>{},["prevent"])),placeholder:"Pilih parameter dari tombol di atas",readonly:""},null,544),[[Q,o.value.parameter]]),a("div",ua,[a("button",{type:"button",class:"btn btn-info",onClick:e[5]||(e[5]=s=>o.value.parameter="")},"Reset")])]),e[15]||(e[15]=a("small",{class:"form-text text-muted mb-2"},[a("strong",null,"Info:"),p(" Gunakan parameter diatas jika dokumen pada tipe ini bersifat multiple atau lebih dari satu, seperti "),a("em",null,"Akte Kelahiran Anak"),p(", "),a("em",null,"SKP 2 Tahun Terakhir"),p(", "),a("em",null,"SK Jabatan"),p(", dan sejenisnya. ")],-1))]),a("div",ca,[e[19]||(e[19]=a("label",null,"File Dokumen (PDF)",-1)),b.value&&D.value?(n(),r("div",pa,[a("a",{href:D.value,target:"_blank",class:"btn btn-sm btn-outline-primary"},e[16]||(e[16]=[a("i",{class:"fas fa-file-pdf"},null,-1),p(" Lihat Dokumen Lama ")]),8,ma),e[17]||(e[17]=a("br",null,null,-1)),e[18]||(e[18]=a("small",{class:"text-muted"},"Jika tidak ingin mengganti file, biarkan kosong.",-1))])):g("",!0),a("div",va,[a("input",{type:"file",class:"custom-file-input",id:"fileInput",accept:"application/pdf",onChange:ue,required:!b.value},null,40,fa),a("label",_a,u(o.value.fileName||"Pilih file"),1)])]),x.value?(n(),r("div",ba,[a("div",ga,[a("div",{class:M(["progress-bar progress-bar-striped progress-bar-animated",ae.value]),role:"progressbar",style:_e({width:m.value+"%"}),"aria-valuenow":m.value,"aria-valuemin":"0","aria-valuemax":"100"},u(m.value)+"% ",15,ha)])])):g("",!0)],32)]),a("div",ya,[a("button",{type:"submit",class:"btn btn-primary",disabled:x.value,form:"uploadForm"},[x.value?(n(),r("span",wa,e[20]||(e[20]=[a("i",{class:"fas fa-spinner fa-spin"},null,-1),p(" Uploading... ")]))):(n(),r("span",xa,u(b.value?"Simpan Perubahan":"Upload"),1))],8,ka)])])])])):g("",!0)],64)}}},Ca=Y(Da,[["__scopeId","data-v-283106f8"]]),Ua={__name:"UserDocs",setup(q){const k=ge(),C=i(null);return Z(()=>{C.value=parseInt(k.params.id,10)}),(K,f)=>(n(),R(Ca,{userId:C.value},null,8,["userId"]))}},Aa=Y(Ua,[["__scopeId","data-v-f467faa0"]]);export{Aa as default};
