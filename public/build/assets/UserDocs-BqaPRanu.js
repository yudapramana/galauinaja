import{_ as X,u as pe,e as r,x as O,f as Y,D as me,c as i,o as n,a,N as E,p as g,d as p,t as u,i as L,v as H,F as M,G as j,n as $,U as Q,h as W,k as ve,M as fe,m as _e,q as T,s as be}from"./app-BpPfrW5D.js";import{S as A}from"./sweetalert2.esm.all-9Qm2jZ7z.js";import{u as ge}from"./MasterDataStore-DPzRb-Di.js";import{L as he,_ as ye}from"./PreviewModal-CPV0N8KW.js";import"./LoadingStore-CcX6WFJA.js";const ke={class:"content-header"},we={class:"container-fluid"},xe={class:"text-primary"},De={class:"text-muted text-sm"},Ce={class:"content"},Ue={class:"container-fluid"},Fe={class:"card shadow-sm rounded-lg"},Pe={class:"card-body p-3"},Ie={class:"input-group mb-3"},Se={class:"input-group-append"},Le=["disabled"],Me={key:0,class:"fa fa-spinner fa-spin mr-1"},$e={key:1,class:"fas fa-sync"},Te={key:1,class:"tree"},Ae={class:"list-unstyled mb-0"},Be={class:"d-flex align-items-center justify-between cursor-pointer py-1 px-2 bg-light rounded small"},Ne=["onClick"],Ve={class:"ml-2 font-weight-bold"},je={class:"text-warning"},Ee={class:"badge badge-pill badge-primary ml-2"},Re=["onClick"],qe={class:"pl-4 mt-1"},Ke={class:"d-flex align-items-center justify-content-between w-100"},ze={class:"d-flex align-items-center"},Ge=["onClick"],Je=["onClick"],Oe={key:0,class:"text-danger mt-1 ml-4 small"},He={key:0,class:"text-muted small ml-4 mt-1"},Qe={key:2,class:"text-center p-5"},We={key:1,class:"modal fade show",style:{display:"block"},tabindex:"-1","aria-modal":"true"},Xe={class:"modal-dialog modal-lg modal-dialog-scrollable"},Ye={class:"modal-content",style:{"max-height":"90vh",display:"flex","flex-direction":"column"}},Ze={class:"modal-header"},ea={class:"modal-title"},aa={class:"modal-body overflow-auto",style:{flex:"1 1 auto"}},ta=["value"],sa={class:"form-group"},la=["value"],oa={class:"form-group"},na={class:"btn-group mb-2 flex-wrap"},ia=["onClick"],ra={class:"input-group mb-3"},da={class:"input-group-append"},ua={class:"form-group"},ca={key:0,class:"mb-2"},pa=["href"],ma={class:"custom-file"},va=["required"],fa={class:"custom-file-label",for:"fileInput"},_a={key:0,class:"mb-3"},ba={class:"progress",style:{height:"20px"}},ga=["aria-valuenow"],ha={class:"modal-footer"},ya=["disabled"],ka={key:0},wa={key:1},xa={__name:"AdminDocumentViewer",props:{userId:Number},setup(R){const k=pe(),C=_e(),q=()=>{C.back()},f=R,U=r([]),w=r(null),F=r(""),_=r(!1),P=r(null),I=r(!1),h=r(null),x=r(!1),m=r(0),K=r(""),S=r([]),B=r(!1),b=r(!1),D=r("");r(null);const v=r(!1),o=r({doc_number:"",doc_date:"",parameter:"",file:null,fileName:"",file_id:null}),N=ge(),z=async t=>{const e=await T.get(`/api/user-documents/${t}`);return K.value=e.data.user.name,e.data.data},V=async()=>{_.value=!0,await N.getDoctypeList(f.userId);const t=await z(f.userId),e=N.doctypeList;U.value=e.map(l=>{const c=t.filter(s=>s.id_doc_type===l.id||s.doc_type_id===l.id||s.doc_type===l.id).sort((s,y)=>s.file_name.localeCompare(y.file_name));return{id:l.id,text:l.text,mandatory:l.mandatory,multiple:l.multiple,expanded:!0,files:c.map(s=>({...s,doc_type_text:l.text}))}}),_.value=!1},Z=async t=>{const l=(await z(f.userId)).filter(s=>s.id_doc_type===t||s.doc_type_id===t||s.doc_type===t).sort((s,y)=>s.file_name.localeCompare(y.file_name)),c=U.value.find(s=>s.id===t);c&&(c.files=l)},ee=O(()=>m.value<30?"bg-danger":m.value<70?"bg-warning":"bg-success"),G=O(()=>{if(!F.value)return U.value;const t=F.value.toLowerCase();return U.value.filter(e=>e.text.toLowerCase().includes(t)||e.files.some(l=>l.file_name.toLowerCase().includes(t)))}),ae=t=>{switch(t){case"Approved":return"badge-success";case"Rejected":return"badge-danger";default:return"badge-secondary"}},te=t=>{t.expanded=!t.expanded},se=async t=>{B.value=!0;try{const e=await T.get(`/api/document-log/${t}`);S.value=e.data.data||[]}catch(e){k.handleAuthError(e),S.value=[]}finally{B.value=!1}},le=t=>`/api/preview/pdf?path=${encodeURI(t)}`,oe=async t=>{if(console.log("file"),console.log(t),t.status=="Approved"){v.value=!1,P.value=t;const e=t==null?void 0:t.file_path;if(!e){v.value=!0;return}w.value=le(e)}else{v.value=!1,P.value=t,w.value=t.file_url;try{const e=await fetch(t.file_url,{method:"HEAD"});if(!e.ok){e.status===404?v.value="not_found":v.value=!0;return}const l=e.headers.get("content-type");(!l||!l.includes("pdf"))&&(v.value=!0)}catch{v.value=!0}}await se(t.id)},ne=async()=>{_.value=!0,await k.syncFilesIndividual(f.userId),await k.getDocsUpdateState(),console.log("eh kepanggil fetchdata didalam onMounted Doclist"),await V(),_.value=!1},ie=t=>{h.value=t,b.value=!1,D.value="",I.value=!0,o.value={doc_number:"",doc_date:"",parameter:"",file:null,file_id:null}},re=(t,e)=>{h.value=e,I.value=!0,b.value=!0,D.value=t.file_url||"",o.value={doc_number:t.doc_number||"",doc_date:t.doc_date||"",parameter:t.parameter||"",file:null,file_id:t.id},console.log("uploadForm"),console.log(o)},J=()=>{I.value=!1,b.value=!1,o.value={doc_number:"",doc_date:"",parameter:"",file:null,file_id:null},D.value=""},de=t=>{const e=t.target.files[0];if(!e||e.type!=="application/pdf"||e.size>1024*1024){A.fire({icon:"error",title:"File Tidak Valid",text:"File harus PDF dan ukuran maksimal 1MB."}),t.target.value="",o.value.fileName="";return}o.value.file=e,o.value.fileName=e.name},ue=async()=>{var e;if(!o.value.file&&!o.value.file_id)return A.fire({icon:"warning",title:"File Belum Dipilih"});x.value=!0;const t=new FormData;t.append("doc_number",o.value.doc_number),t.append("doc_date",o.value.doc_date),t.append("parameter",o.value.parameter),o.value.file&&t.append("file",o.value.file),t.append("id_doc_type",h.value.id),t.append("user_id",f.userId);try{o.value.file_id?await T.post(`/api/reupload-document/${o.value.file_id}`,t,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:l=>{l.total&&(m.value=Math.round(l.loaded*100/l.total))}}):await T.post("/api/upload-document",t,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:l=>{l.total&&(m.value=Math.round(l.loaded*100/l.total))}}),A.fire({icon:"success",title:o.value.file_id?"Dokumen berhasil diperbarui. Perubahan akan tampil dalam 1â€“2 menit, mohon tunggu sebentar.":"Dokumen berhasil diupload. Perubahan akan tampil dalam 1â€“2 menit, mohon tunggu sebentar.",showConfirmButton:!1,timer:2e3}),await Z(h.value.id),J()}catch(l){let c="Terjadi kesalahan saat mengupload file.";if(((e=l.response)==null?void 0:e.status)===422&&l.response.data.errors){const s=l.response.data.errors;c=Object.values(s).flat().join(`
`)}A.fire({icon:"error",title:"Upload Gagal",text:c})}finally{x.value=!1,m.value=0}};return Y(V),me(()=>f.userId,V),(t,e)=>{var l,c;return n(),i(M,null,[a("section",ke,[a("div",we,[a("h3",xe,[e[6]||(e[6]=p("ðŸ“‚ Dokumen ")),a("small",De,u(K.value),1)]),a("button",{class:"btn btn-sm btn-secondary mt-2",onClick:q},e[7]||(e[7]=[a("i",{class:"fas fa-arrow-left mr-1"},null,-1),p(" Kembali ")]))])]),a("section",Ce,[a("div",Ue,[a("div",Fe,[a("div",Pe,[a("div",Ie,[L(a("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=s=>F.value=s),class:"form-control",placeholder:"Cari dokumen..."},null,512),[[H,F.value]]),a("div",Se,[a("button",{disabled:_.value,class:"btn btn-outline-secondary",type:"button",onClick:ne},[_.value?(n(),i("i",Me)):(n(),i("i",$e))],8,Le),a("button",{class:"btn btn-outline-secondary",type:"button",onClick:e[1]||(e[1]=(...s)=>t.clearSearch&&t.clearSearch(...s))},"Reset")])]),_.value?(n(),E(he,{key:0})):G.value.length?(n(),i("div",Te,[a("ul",Ae,[(n(!0),i(M,null,j(G.value,(s,y)=>(n(),i("li",{key:s.id,class:"mb-2"},[a("div",Be,[a("div",{onClick:d=>te(s),class:"flex-grow-1 d-flex align-items-center"},[a("i",{class:$([s.expanded?"fas fa-folder-open text-warning":"fas fa-folder text-secondary","mr-2"])},null,2),a("span",Ve,[p(u(y+1)+". "+u(s.text)+" ",1),L(a("span",je,"*",512),[[Q,s.mandatory==1]]),a("span",Ee,u(s.files.length),1)])],8,Ne),a("button",{class:"btn btn-sm btn-success ml-2",onClick:d=>ie(s)},"+ Upload",8,Re)]),L(a("ul",qe,[(n(!0),i(M,null,j(s.files,d=>(n(),i("li",{key:d.id,class:"cursor-pointer p-1 rounded hover-bg-light small"},[a("div",Ke,[a("div",ze,[e[8]||(e[8]=a("i",{class:"fas fa-file-pdf text-danger mr-2"},null,-1)),a("span",{onClick:ce=>oe(d)},u(d.file_name),9,Ge),a("span",{class:$(["badge badge-sm ml-2",ae(d.status)])},u(d.status||"Pending"),3),d.status!=="Approved"?(n(),i("span",{key:0,class:"badge badge-sm badge-primary ml-2",onClick:ce=>re(d,s)}," Perbarui ",8,Je)):g("",!0)])]),d.status==="Rejected"&&d.verif_notes?(n(),i("div",Oe,[e[9]||(e[9]=a("i",{class:"fas fa-info-circle"},null,-1)),p(" Catatan: "+u(d.verif_notes),1)])):g("",!0)]))),128)),s.files.length?g("",!0):(n(),i("li",He," Tidak ada file diupload. "))],512),[[Q,s.expanded]])]))),128))])])):(n(),i("div",Qe,e[10]||(e[10]=[a("span",{class:"text-muted"},"Data tidak ditemukan.",-1)])))])])])]),w.value?(n(),E(ye,{key:0,"preview-url":w.value,"selected-preview-file":P.value,"is-loading-verval":B.value,vervalLogs:S.value,pdfError:v.value,onClose:e[2]||(e[2]=s=>{w.value=null,P.value=null,S.value=[]})},null,8,["preview-url","selected-preview-file","is-loading-verval","vervalLogs","pdfError"])):g("",!0),I.value?(n(),i("div",We,[a("div",Xe,[a("div",Ye,[a("div",Ze,[a("h5",ea,u(b.value?"Edit Dokumen Pegawai":"Upload Dokumen Pegawai"),1),a("button",{type:"button",class:"close",onClick:J},e[11]||(e[11]=[a("span",null,"Ã—",-1)]))]),a("div",aa,[a("form",{onSubmit:W(ue,["prevent"]),id:"uploadForm"},[a("input",{type:"hidden",value:(l=h.value)==null?void 0:l.id},null,8,ta),a("div",sa,[e[12]||(e[12]=a("label",null,"Tipe Dokumen",-1)),a("input",{type:"text",class:"form-control",value:(c=h.value)==null?void 0:c.text,readonly:""},null,8,la)]),a("div",oa,[e[13]||(e[13]=a("label",null,"Pilih Parameter (Opsional)",-1)),e[14]||(e[14]=a("br",null,null,-1)),a("div",na,[(n(!0),i(M,null,j(ve(N).docParameters,s=>(n(),i("button",{key:s,type:"button",class:$(["btn btn-xs btn-outline-secondary mb-1",{active:o.value.parameter===s}]),onClick:y=>o.value.parameter=s},u(s),11,ia))),128))]),a("div",ra,[L(a("input",{"onUpdate:modelValue":e[3]||(e[3]=s=>o.value.parameter=s),type:"text",class:"form-control",required:"",onKeydown:e[4]||(e[4]=W(()=>{},["prevent"])),placeholder:"Pilih parameter dari tombol di atas",readonly:""},null,544),[[H,o.value.parameter]]),a("div",da,[a("button",{type:"button",class:"btn btn-info",onClick:e[5]||(e[5]=s=>o.value.parameter="")},"Reset")])]),e[15]||(e[15]=a("small",{class:"form-text text-muted mb-2"},[a("strong",null,"Info:"),p(" Gunakan parameter diatas jika dokumen pada tipe ini bersifat multiple atau lebih dari satu, seperti "),a("em",null,"Akte Kelahiran Anak"),p(", "),a("em",null,"SKP 2 Tahun Terakhir"),p(", "),a("em",null,"SK Jabatan"),p(", dan sejenisnya. ")],-1))]),a("div",ua,[e[19]||(e[19]=a("label",null,"File Dokumen (PDF)",-1)),b.value&&D.value?(n(),i("div",ca,[a("a",{href:D.value,target:"_blank",class:"btn btn-sm btn-outline-primary"},e[16]||(e[16]=[a("i",{class:"fas fa-file-pdf"},null,-1),p(" Lihat Dokumen Lama ")]),8,pa),e[17]||(e[17]=a("br",null,null,-1)),e[18]||(e[18]=a("small",{class:"text-muted"},"Jika tidak ingin mengganti file, biarkan kosong.",-1))])):g("",!0),a("div",ma,[a("input",{type:"file",class:"custom-file-input",id:"fileInput",accept:"application/pdf",onChange:de,required:!b.value},null,40,va),a("label",fa,u(o.value.fileName||"Pilih file"),1)])]),x.value?(n(),i("div",_a,[a("div",ba,[a("div",{class:$(["progress-bar progress-bar-striped progress-bar-animated",ee.value]),role:"progressbar",style:fe({width:m.value+"%"}),"aria-valuenow":m.value,"aria-valuemin":"0","aria-valuemax":"100"},u(m.value)+"% ",15,ga)])])):g("",!0)],32)]),a("div",ha,[a("button",{type:"submit",class:"btn btn-primary",disabled:x.value,form:"uploadForm"},[x.value?(n(),i("span",ka,e[20]||(e[20]=[a("i",{class:"fas fa-spinner fa-spin"},null,-1),p(" Uploading... ")]))):(n(),i("span",wa,u(b.value?"Simpan Perubahan":"Upload"),1))],8,ya)])])])])):g("",!0)],64)}}},Da=X(xa,[["__scopeId","data-v-9d9365ad"]]),Ca={__name:"UserDocs",setup(R){const k=be(),C=r(null);return Y(()=>{C.value=parseInt(k.params.id,10)}),(q,f)=>(n(),E(Da,{userId:C.value},null,8,["userId"]))}},La=X(Ca,[["__scopeId","data-v-f467faa0"]]);export{La as default};
