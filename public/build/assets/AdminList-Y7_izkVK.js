import{u as ee,r as u,c as m,o as c,a as e,t as o,d as E,m as L,F as M,C as G,x as U,P as me,B as Q,A as Y,f as ve,k as N,v as J,n as j,j as B,s as X,D as pe,L as ge,Q as fe,E as Z}from"./app-CS__mXI0.js";import{u as te}from"./toastr-CjOZhsla.js";import{u as he}from"./MasterDataStore-BNS_OTA7.js";import{f as be}from"./helper-D4kaxrhs.js";import"./LoadingStore-ChlqzpUI.js";const _e=["checked"],ye={class:"text-muted m-0 p-0",style:{"font-size":"small !important"}},ke={width:"20%"},xe=["value","selected"],Se={__name:"AdminRow",props:{user:{type:Object,required:!0},index:{type:Number,required:!0},selectAll:{type:Boolean,default:!1}},emits:["userDeleted","editUser","confirmUserDeletion","toggleSelection"],setup(d,{emit:P}){const b=te(),T=ee(),v=d,R=P,s=u([{name:"SUPERADMIN",value:1},{name:"ADMIN",value:2},{name:"USER",value:3},{name:"REVIEWER",value:4}]),k=(w,x)=>{U.patch(`/api/users/${w.id}/change-role`,{role:x}).then(()=>{b.success("Role berhasil diubah"),R("userDeleted")}).catch(n=>{var r,_;b.error(((_=(r=n==null?void 0:n.response)==null?void 0:r.data)==null?void 0:_.message)||"Gagal mengubah role")})},D=()=>{R("toggleSelection",v.user)};return(w,x)=>{var n;return c(),m("tr",null,[e("td",null,[e("input",{type:"checkbox",checked:d.selectAll,onChange:D},null,40,_e)]),e("td",null,o(d.index+1),1),e("td",null,[E(o(d.user.name)+" ",1),e("p",ye,o(d.user.jabatan)+" pada "+o(d.user.org_name),1)]),e("td",null,o(d.user.email),1),e("td",ke,[((n=L(T).user)==null?void 0:n.role)==="SUPERADMIN"?(c(),m("select",{key:0,name:"role",id:"role",class:"form-control",style:{width:"200px"},onChange:x[0]||(x[0]=r=>k(d.user,r.target.value))},[(c(!0),m(M,null,G(s.value,r=>(c(),m("option",{key:r.value,value:r.value,selected:d.user.role===r.name},o(r.name),9,xe))),128))],32)):(c(),m(M,{key:1},[E(o(d.user.role),1)],64))])])}}},Ue=me("TableIndexStore",()=>{const d=u(0);return{tableIndex:d,incrementIndex:()=>{d.value=d.value+1}}}),Ee={class:"content-header"},Re={class:"container-fluid"},De={class:"d-flex justify-content-between align-items-center"},Ie={class:"btn-group"},Me=["disabled"],Pe=["disabled"],we={class:"content"},Ce={class:"container-fluid"},Ae={class:"card"},Ne={class:"card-header"},$e={class:"card-body table-responsive p-0"},Te={class:"table table-bordered table-hover text-sm"},Ve={class:"thead-light"},je={style:{width:"36px"}},Be=["checked"],Le={key:0},Ge={key:1},He={class:"card-footer clearfix"},Fe={class:"d-flex justify-content-between align-items-center"},We={class:"text-muted"},ze={class:"pagination pagination-sm m-0"},qe={class:"page-item disabled"},Oe={class:"page-link"},Ke={class:"modal fade",id:"adminPromoteModal",tabindex:"-1",role:"dialog"},Qe={class:"modal-dialog modal-lg",role:"document"},Ye={class:"modal-content"},Je={class:"modal-body pt-2"},Xe={class:"form-group mb-2"},Ze={class:"table-responsive border rounded"},et={class:"table table-sm m-0"},tt={key:0},at={key:1},lt=["onClick"],st=["value"],nt={class:"text-muted",style:{"font-size":"12px"}},ot={class:"form-group mt-3"},rt=["disabled"],it=["value"],ut=["value"],dt=["value"],ct={class:"modal-footer py-2"},mt=["disabled"],vt={key:0,class:"fas fa-spinner fa-spin mr-1"},yt={__name:"AdminList",setup(d){const P=he(),b=ee(),T=Ue(),v=te(),R=u([]),s=u({current_page:1,per_page:10,total:0,from:0,to:0,last_page:1}),k=u(""),D=u(!1),w=u(!1);u(!1);const x=u({}),n=u([]),r=u(!1),_={SUPERADMIN:1,ADMIN:2,USER:3,REVIEWER:4},h=u(""),V=u(!1),S=u([]),p=u(null),y=u(""),C=u(!1),ae=Z(async()=>{if(!h.value||h.value.trim().length<2){S.value=[];return}V.value=!0;try{const{data:a}=await U.get("/api/users",{params:{search:h.value,per_page:10}});S.value=(a==null?void 0:a.data)||[]}catch{v.error("Gagal mencari user")}finally{V.value=!1}},350);Q(h,()=>ae());const le=async()=>{var a,t,i;if(!(!p.value||!y.value)){if(((a=b.user)==null?void 0:a.role)!=="SUPERADMIN"){v.error("Hanya SUPERADMIN yang dapat mempromosikan role");return}C.value=!0;try{await U.patch(`/api/users/${p.value}/change-role`,{role:y.value}),v.success("Role berhasil dipromosikan"),await g(s.value.current_page),p.value=null,y.value="",h.value="",S.value=[],$("#adminPromoteModal").modal("hide")}catch(f){v.error(((i=(t=f==null?void 0:f.response)==null?void 0:t.data)==null?void 0:i.message)||"Gagal mempromosikan role")}finally{C.value=!1}}},g=async(a=1)=>{D.value=!0;try{const t=await U.get("/api/users",{params:{page:a,search:k.value,exclude_role:"User"}});R.value=t.data.data,s.value={...s.value,...t.data.meta,...t.data},T.setFrom(s.value.from||0),n.value=[],r.value=!1}catch(t){t.response&&t.response.status===401?(console.warn("Unauthorized. Logging out..."),b.logout()):console.error("Gagal memuat data Pengelola:",t)}finally{D.value=!1}},I=Y(()=>(R.value||[]).filter(a=>{const t=a.roles||[];return a.role!=null?Number(a.role)!==_.USER:!t.some(i=>((i==null?void 0:i.name)||"").toLowerCase()==="user")})),se=Y(()=>(s.value.current_page-1)*(s.value.per_page||10)),ne=a=>{var t,i,f,l;return{...a,name:((t=a.employee)==null?void 0:t.full_name)||a.name,jabatan:((i=a.employee)==null?void 0:i.job_title)||"-",org_name:((l=(f=a.employee)==null?void 0:f.work_unit)==null?void 0:l.unit_name)||"-",formatted_created_at:a.formatted_created_at||be(a.created_at),role:a.role}},oe=()=>{p.value=null,y.value="",h.value="",S.value=[],$("#adminPromoteModal").modal("show")},re=a=>{var t;w.value=!0,x.value={...a,...a.employee,id_work_unit:(t=a.employee)==null?void 0:t.id_work_unit,role_names:(a.roles||[]).map(i=>i.name)}},ie=async a=>{if(confirm("Yakin ingin menghapus pengguna ini?"))try{await U.delete(`/api/users/${a}`),v.success("Pengguna berhasil dihapus"),I.value.length===1&&s.value.current_page>1?await g(s.value.current_page-1):await g(s.value.current_page)}catch{v.error("Gagal menghapus pengguna")}},ue=async()=>{var a,t;if(n.value.length!==0&&confirm(`Hapus ${n.value.length} pengguna terpilih?`))try{await U.post("/api/users/bulk-delete",{ids:n.value}),v.success("Pengguna terpilih berhasil dihapus"),await g(s.value.current_page)}catch(i){v.error(((t=(a=i==null?void 0:i.response)==null?void 0:a.data)==null?void 0:t.message)||"Gagal menghapus massal")}},H=()=>{r.value=!r.value,r.value?n.value=I.value.map(a=>a.id):n.value=[]},de=a=>{const t=n.value.indexOf(a.id);t>=0?n.value.splice(t,1):n.value.push(a.id),r.value=n.value.length===I.value.length},ce=()=>{g(s.value.current_page)};return Q(k,Z(()=>g(1),400)),ve(()=>{g(),P.getWorkunitList()}),(a,t)=>{var i,f;return c(),m(M,null,[e("section",Ee,[e("div",Re,[e("div",De,[t[9]||(t[9]=e("h1",{class:"mb-2"},"Daftar Pengelola",-1)),e("div",Ie,[e("button",{class:"btn btn-outline-secondary btn-sm",onClick:H},[t[7]||(t[7]=e("i",{class:"fas fa-check-square mr-1"},null,-1)),E(o(r.value?"Batal Pilih Semua":"Pilih Semua"),1)]),e("button",{class:"btn btn-danger btn-sm",disabled:n.value.length===0,onClick:ue},[t[8]||(t[8]=e("i",{class:"fas fa-trash mr-1"},null,-1)),E("Hapus Terpilih ("+o(n.value.length)+") ",1)],8,Me),e("button",{class:"btn btn-primary btn-sm",onClick:oe,disabled:((i=L(b).user)==null?void 0:i.role)!=="SUPERADMIN",title:"Hanya SUPERADMIN yang bisa mempromosikan role"}," + Tambah Pengelola ",8,Pe)])])])]),e("section",we,[e("div",Ce,[e("div",Ae,[e("div",Ne,[N(e("input",{"onUpdate:modelValue":t[0]||(t[0]=l=>k.value=l),type:"text",class:"form-control",placeholder:"Cari nama, email, NIP, atau unit kerja..."},null,512),[[J,k.value]])]),e("div",$e,[e("table",Te,[e("thead",Ve,[e("tr",null,[e("th",je,[e("input",{type:"checkbox",checked:r.value,onChange:H},null,40,Be)]),t[10]||(t[10]=e("th",{style:{width:"40px"}},"#",-1)),t[11]||(t[11]=e("th",null,"Nama",-1)),t[12]||(t[12]=e("th",null,"Email",-1)),t[13]||(t[13]=e("th",null,"Role",-1))])]),e("tbody",null,[D.value?(c(),m("tr",Le,t[14]||(t[14]=[e("td",{colspan:"7",class:"text-center"},"Memuat data...",-1)]))):I.value.length===0?(c(),m("tr",Ge,t[15]||(t[15]=[e("td",{colspan:"7",class:"text-center"},"Tidak ada data Pengelola ditemukan.",-1)]))):(c(!0),m(M,{key:2},G(I.value,(l,A)=>(c(),ge(Se,{key:l.id,user:ne(l),index:A+se.value,"select-all":r.value||n.value.includes(l.id),onToggleSelection:de,onEditUser:re,onConfirmUserDeletion:ie,onUserDeleted:ce},null,8,["user","index","select-all"]))),128))])])]),e("div",He,[e("div",Fe,[e("div",We," Menampilkan "+o(s.value.from)+" - "+o(s.value.to)+" dari "+o(s.value.total)+' pengguna (role ≠ "User") ',1),e("ul",ze,[e("li",{class:j(["page-item",{disabled:s.value.current_page===1}])},[e("a",{class:"page-link",href:"#",onClick:t[1]||(t[1]=B(l=>g(s.value.current_page-1),["prevent"]))},"«")],2),e("li",qe,[e("span",Oe," Halaman "+o(s.value.current_page)+" / "+o(s.value.last_page),1)]),e("li",{class:j(["page-item",{disabled:s.value.current_page===s.value.last_page}])},[e("a",{class:"page-link",href:"#",onClick:t[2]||(t[2]=B(l=>g(s.value.current_page+1),["prevent"]))},"»")],2)])])])])]),e("div",Ke,[e("div",Qe,[e("div",Ye,[t[26]||(t[26]=e("div",{class:"modal-header py-2"},[e("h5",{class:"modal-title"},[e("i",{class:"fas fa-user-shield me-2"}),E("Tambah Pengelola (Promosi Role) ")]),e("button",{type:"button",class:"close","data-dismiss":"modal"},[e("span",null,"×")])],-1)),e("div",Je,[e("div",Xe,[t[16]||(t[16]=e("label",{class:"mb-1"},"Cari User",-1)),N(e("input",{"onUpdate:modelValue":t[3]||(t[3]=l=>h.value=l),type:"text",class:"form-control form-control-sm",placeholder:"Ketik nama atau email…"},null,512),[[J,h.value]]),t[17]||(t[17]=e("small",{class:"text-muted"},"Hanya SUPERADMIN yang bisa mempromosikan role.",-1))]),e("div",Ze,[e("table",et,[t[20]||(t[20]=e("thead",null,[e("tr",null,[e("th",{style:{width:"36px"}}),e("th",null,"Nama"),e("th",null,"Email"),e("th",null,"Role Saat Ini")])],-1)),e("tbody",null,[V.value?(c(),m("tr",tt,t[18]||(t[18]=[e("td",{colspan:"4",class:"text-center"},"Mencari…",-1)]))):S.value.length===0?(c(),m("tr",at,t[19]||(t[19]=[e("td",{colspan:"4",class:"text-center"},"Belum ada hasil. Ketik kata kunci di atas.",-1)]))):X("",!0),(c(!0),m(M,null,G(S.value,l=>{var A,F,W,z,q,O;return c(),m("tr",{key:l.id,class:j({"table-active":p.value===l.id}),style:{cursor:"pointer"},onClick:K=>p.value=l.id},[e("td",null,[N(e("input",{type:"radio",name:"candidate",value:l.id,"onUpdate:modelValue":t[4]||(t[4]=K=>p.value=K),onClick:t[5]||(t[5]=B(()=>{},["stop"]))},null,8,st),[[fe,p.value]])]),e("td",null,[e("strong",null,o(((A=l.employee)==null?void 0:A.full_name)||l.name),1),e("div",nt,o(((F=l.employee)==null?void 0:F.job_title)||"-")+" • "+o(((z=(W=l.employee)==null?void 0:W.work_unit)==null?void 0:z.unit_name)||"-"),1)]),e("td",null,o(l.email),1),e("td",null,o(l.role&&String(l.role)||((O=(q=l.roles)==null?void 0:q[0])==null?void 0:O.name)||"-"),1)],10,lt)}),128))])])]),e("div",ot,[t[22]||(t[22]=e("label",{class:"mb-1"},"Role Target",-1)),N(e("select",{class:"form-control form-control-sm","onUpdate:modelValue":t[6]||(t[6]=l=>y.value=l),disabled:((f=L(b).user)==null?void 0:f.role)!=="SUPERADMIN"},[t[21]||(t[21]=e("option",{disabled:"",value:""},"— Pilih role —",-1)),e("option",{value:_.SUPERADMIN},"SUPERADMIN",8,it),e("option",{value:_.ADMIN},"ADMIN",8,ut),e("option",{value:_.REVIEWER},"REVIEWER",8,dt)],8,rt),[[pe,y.value]]),t[23]||(t[23]=e("small",{class:"text-muted"},"USER tidak tersedia di sini karena fokusnya promosi.",-1))])]),e("div",ct,[t[25]||(t[25]=e("button",{type:"button",class:"btn btn-default btn-sm","data-dismiss":"modal"},"Tutup",-1)),e("button",{type:"button",class:"btn btn-primary btn-sm",disabled:!p.value||!y.value||C.value,onClick:le},[C.value?(c(),m("i",vt)):X("",!0),t[24]||(t[24]=E(" Simpan "))],8,mt)])])])])])],64)}}};export{yt as default};
