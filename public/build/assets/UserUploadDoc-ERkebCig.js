import{_ as ue,g as u,N as K,u as _e,y as me,c as l,a as e,j as U,v as T,F as P,z as I,t as c,A as V,l as f,b as k,i as pe,I as ve,o,O as he,p as fe,e as ge,m as R}from"./app-ClEBpTSD.js";import{S as C}from"./sweetalert2.all-DWkFJy1E.js";import{u as be}from"./MasterDataStore-CDtaQKOa.js";import"./LoadingStore-DaenCWHc.js";const i=F=>(fe("data-v-95d37d37"),F=F(),ge(),F),ye=i(()=>e("section",{class:"content-header"},[e("div",{class:"container-fluid"},[e("h3",{class:"text-primary"},"ðŸ“‚ Upload Dokumen")])],-1)),ke={class:"content"},xe={class:"container-fluid"},we={class:"card shadow-sm rounded-lg"},De={class:"card-body p-3"},Ue={class:"input-group mb-3"},Ce={key:0,class:"text-center p-5"},Fe=i(()=>e("div",{class:"spinner-border text-primary mb-2",role:"status"},[e("span",{class:"sr-only"},"Loading...")],-1)),Se=i(()=>e("div",{class:"text-muted"},"Memuat daftar dokumen...",-1)),Me=[Fe,Se],Le={key:1,class:"tree"},Te={class:"list-unstyled mb-0"},Pe={class:"d-flex align-items-center justify-between cursor-pointer py-1 px-2 bg-light rounded small"},Ve=["onClick"],Be={class:"ml-2 font-weight-bold"},je={class:"badge badge-pill badge-primary ml-2"},$e=["onClick"],Ie={class:"pl-4 mt-1"},Re={class:"d-flex align-items-center justify-content-between w-100"},Ne=["onClick"],ze=i(()=>e("i",{class:"fas fa-file-pdf text-danger mr-2"},null,-1)),qe=["onClick"],Ae={key:0,class:"text-danger mt-1 ml-4 small"},Ge=i(()=>e("i",{class:"fas fa-info-circle"},null,-1)),Oe={key:0,class:"text-muted small ml-4 mt-1"},Ee={key:2,class:"text-center p-5"},He=i(()=>e("span",{class:"text-muted"},"Data tidak ditemukan.",-1)),Qe=[He],Je={key:0,class:"modal fade show",style:{display:"block"},tabindex:"-1","aria-modal":"true"},Ke={class:"modal-dialog modal-xl"},We={class:"modal-content"},Xe={class:"modal-header p-2"},Ye=i(()=>e("h5",{class:"modal-title"},"ðŸ“„ Preview Dokumen",-1)),Ze=i(()=>e("span",null,"Ã—",-1)),et=[Ze],tt={class:"modal-body p-3"},at={class:"row"},st={class:"col-md-6 mb-3"},lt={class:"table table-sm table-bordered"},ot=i(()=>e("th",{style:{width:"40%"}},"Tipe Dokumen",-1)),nt=i(()=>e("th",null,"Nomor Dokumen",-1)),it=i(()=>e("th",null,"Tanggal Dokumen",-1)),dt=i(()=>e("th",null,"Parameter",-1)),rt=i(()=>e("th",null,"Status",-1)),ct={key:0},ut=i(()=>e("th",null,"Catatan Verifikator",-1)),_t={class:"text-danger"},mt=i(()=>e("h6",{class:"text-secondary mb-2"},[e("i",{class:"fas fa-clipboard-check mr-1"}),k(" Riwayat Verifikasi ")],-1)),pt={key:0,class:"text-muted small d-flex align-items-center"},vt=i(()=>e("i",{class:"fas fa-spinner fa-spin mr-2"},null,-1)),ht={key:1,class:"list-group list-group-unbordered small mb-2"},ft={class:"font-weight-bold text-sm"},gt=i(()=>e("span",{class:"text-muted mx-1"},"oleh",-1)),bt={class:"font-italic text-sm"},yt={class:"text-muted"},kt={key:0,class:"text-danger mt-1 small"},xt=i(()=>e("i",{class:"fas fa-comment-dots mr-1"},null,-1)),wt={key:2,class:"text-muted small"},Dt={class:"col-md-6"},Ut=["src"],Ct={key:1,class:"text-muted text-center py-5"},Ft={key:0},St={key:1},Mt={key:1,class:"modal fade show",style:{display:"block"},tabindex:"-1","aria-modal":"true"},Lt={class:"modal-dialog modal-lg"},Tt={class:"modal-content"},Pt={class:"modal-header"},Vt={class:"modal-title"},Bt=i(()=>e("span",null,"Ã—",-1)),jt=[Bt],$t={class:"modal-body"},It=["value"],Rt={class:"form-group"},Nt=i(()=>e("label",null,"Tipe Dokumen",-1)),zt=["value"],qt={class:"form-group"},At=i(()=>e("label",null,"Nomor Dokumen",-1)),Gt={class:"form-group"},Ot=i(()=>e("label",null,"Tanggal Dokumen",-1)),Et={class:"form-group"},Ht=i(()=>e("label",null,"Parameter (Opsional)",-1)),Qt={class:"form-group"},Jt=i(()=>e("label",null,"Pilih File (PDF)",-1)),Kt={key:0,class:"mb-3"},Wt={class:"progress",style:{height:"20px"}},Xt=["aria-valuenow"],Yt={class:"text-right"},Zt=["disabled"],ea={key:0},ta=i(()=>e("i",{class:"fas fa-spinner fa-spin"},null,-1)),aa={key:1},sa={__name:"UserUploadDoc",setup(F){const S=u([]),x=u(null),w=u(""),B=u(!1),m=u(null),M=u([]),j=u(!1),L=u(!1),g=u(null),D=u(!1),h=u(0),W=K(()=>h.value<30?"bg-danger":h.value<70?"bg-warning":"bg-success"),X=u(null),v=u(!1),Y=()=>{v.value=!1},Z=()=>{v.value=!0},N=t=>{switch(t){case"Approved":return"badge-success";case"Rejected":return"badge-danger";default:return"badge-secondary"}},z=be(),b=_e(),d=u({doc_number:"",doc_date:"",parameter:"",file:null,file_id:null}),ee=async t=>{j.value=!0;try{const a=await R.get(`/api/document-log/${t}`);M.value=a.data.data||[]}catch(a){console.error("Gagal mengambil log verval:",a),M.value=[]}finally{j.value=!1}},te=async()=>{console.log("eh kepanggil fetchdata didalam"),await z.getDoctypeList(),await b.getMyDocuments();const t=z.doctypeList,a=b.myDocuments;S.value=t.map(s=>{const p=a.filter(r=>r.id_doc_type===s.id||r.doc_type_id===s.id||r.doc_type===s.id).sort((r,y)=>r.file_name.localeCompare(y.file_name));return{id:s.id,text:s.text,expanded:!0,files:p.map(r=>({...r,doc_type_text:s.text}))}})},ae=t=>{t.expanded=!t.expanded},se=async t=>{console.log("file"),console.log(t),v.value=!1,m.value=t,x.value=t.file_url;try{const a=await fetch(t.file_url,{method:"HEAD"});if(!a.ok){a.status===404?v.value="not_found":v.value=!0;return}const s=a.headers.get("content-type");(!s||!s.includes("pdf"))&&(v.value=!0)}catch{v.value=!0}await ee(t.id)},le=()=>{w.value=""},q=K(()=>{if(!w.value)return S.value;const t=w.value.toLowerCase();return S.value.filter(a=>a.text.toLowerCase().includes(t)||a.files.some(s=>s.file_name.toLowerCase().includes(t)))}),oe=t=>{g.value=t,L.value=!0,d.value={doc_number:"",doc_date:"",parameter:"",file:null}},A=()=>{L.value=!1,d.value={doc_number:"",doc_date:"",parameter:"",file:null,file_id:null}},ne=t=>{const a=t.target.files[0];if(!a){d.value.file=null;return}if(a.type!=="application/pdf"){C.fire({icon:"error",title:"Format Salah",text:"File harus berformat PDF!"}),t.target.value="",d.value.file=null;return}const s=1*1024*1024;if(a.size>s){C.fire({icon:"error",title:"Ukuran File Terlalu Besar",text:"Ukuran maksimal file adalah 1MB!"}),t.target.value="",d.value.file=null;return}d.value.file=a},ie=(t,a)=>{g.value=a,L.value=!0,d.value={doc_number:t.doc_number||"",doc_date:t.doc_date||"",parameter:t.parameter||"",file:null,file_id:t.id}},de=async()=>{var a;if(!d.value.file&&!d.value.file_id){C.fire({icon:"warning",title:"File Belum Dipilih",text:"Silakan pilih file terlebih dahulu."});return}D.value=!0;const t=new FormData;t.append("doc_number",d.value.doc_number),t.append("doc_date",d.value.doc_date),t.append("parameter",d.value.parameter),d.value.file&&t.append("file",d.value.file),t.append("id_doc_type",g.value.id);try{d.value.file_id?await R.post(`/api/reupload-document/${d.value.file_id}`,t,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:s=>{s.total&&(h.value=Math.round(s.loaded*100/s.total))}}):await R.post("/api/upload-document",t,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:s=>{s.total&&(h.value=Math.round(s.loaded*100/s.total))}}),C.fire({icon:"success",title:d.value.file_id?"Reupload Berhasil!":"Upload Berhasil!",showConfirmButton:!1,timer:1500}),await re(g.value.id),A()}catch(s){let p="Terjadi kesalahan saat mengupload file.";if(((a=s.response)==null?void 0:a.status)===422&&s.response.data.errors){const r=s.response.data.errors;p=Object.values(r).flat().join(`
`)}C.fire({icon:"error",title:"Upload Gagal",text:p})}finally{D.value=!1,h.value=0}},re=async t=>{b.docsUpdateState=!0,await b.getMyDocuments();const s=b.myDocuments.filter(r=>r.id_doc_type===t||r.doc_type_id===t||r.doc_type===t).sort((r,y)=>r.file_name.localeCompare(y.file_name)),p=S.value.find(r=>r.id===t);p&&(p.files=s)};return me(async()=>{B.value=!0,await b.getDocsUpdateState(),console.log("eh kepanggil fetchdata didalam onMounted Doclist"),await te(),B.value=!1}),(t,a)=>{var s,p,r,y,G,O,E,H,Q,J;return o(),l(P,null,[ye,e("section",ke,[e("div",xe,[e("div",we,[e("div",De,[e("div",Ue,[U(e("input",{type:"text","onUpdate:modelValue":a[0]||(a[0]=n=>w.value=n),class:"form-control",placeholder:"Cari dokumen..."},null,512),[[T,w.value]]),e("div",{class:"input-group-append"},[e("button",{class:"btn btn-outline-secondary",type:"button",onClick:le},"Reset")])]),B.value?(o(),l("div",Ce,Me)):q.value.length?(o(),l("div",Le,[e("ul",Te,[(o(!0),l(P,null,I(q.value,(n,$)=>(o(),l("li",{key:n.id,class:"mb-2"},[e("div",Pe,[e("div",{onClick:_=>ae(n),class:"flex-grow-1 d-flex align-items-center"},[e("i",{class:V([n.expanded?"fas fa-folder-open text-warning":"fas fa-folder text-secondary","mr-2"])},null,2),e("span",Be,[k(c($+1)+". "+c(n.text)+" ",1),e("span",je,c(n.files.length),1)])],8,Ve),e("button",{class:"btn btn-sm btn-success ml-2",onClick:_=>oe(n)},"+ Upload",8,$e)]),U(e("ul",Ie,[(o(!0),l(P,null,I(n.files,_=>(o(),l("li",{key:_.id,class:"cursor-pointer p-1 rounded hover-bg-light small"},[e("div",Re,[e("div",{onClick:ce=>se(_),class:"d-flex align-items-center"},[ze,e("span",null,c(_.file_name),1),e("span",{class:V(["badge badge-sm ml-2",N(_.status)])},c(_.status||"Pending"),3)],8,Ne),_.status==="Rejected"?(o(),l("button",{key:0,class:"btn btn-sm btn-outline-danger ml-2",onClick:ce=>ie(_,n)}," Reupload ",8,qe)):f("",!0)]),_.status==="Rejected"&&_.verif_notes?(o(),l("div",Ae,[Ge,k(" Catatan: "+c(_.verif_notes),1)])):f("",!0)]))),128)),n.files.length?f("",!0):(o(),l("li",Oe," Tidak ada file diupload. "))],512),[[he,n.expanded]])]))),128))])])):(o(),l("div",Ee,Qe))])])])]),x.value?(o(),l("div",Je,[e("div",Ke,[e("div",We,[e("div",Xe,[Ye,e("button",{type:"button",class:"close",onClick:a[1]||(a[1]=n=>{x.value=null,m.value=null})},et)]),e("div",tt,[e("div",at,[e("div",st,[e("table",lt,[e("tbody",null,[e("tr",null,[ot,e("td",null,c(((s=m.value)==null?void 0:s.doc_type_text)||"â€”"),1)]),e("tr",null,[nt,e("td",null,c(((p=m.value)==null?void 0:p.doc_number)||"â€”"),1)]),e("tr",null,[it,e("td",null,c(((r=m.value)==null?void 0:r.doc_date)||"â€”"),1)]),e("tr",null,[dt,e("td",null,c(((y=m.value)==null?void 0:y.parameter)||"â€”"),1)]),e("tr",null,[rt,e("td",null,[e("span",{class:V(["badge",N((G=m.value)==null?void 0:G.status)])},c(((O=m.value)==null?void 0:O.status)||"Pending"),3)])]),(E=m.value)!=null&&E.verif_notes?(o(),l("tr",ct,[ut,e("td",_t,c(m.value.verif_notes),1)])):f("",!0)])]),mt,j.value?(o(),l("div",pt,[vt,k(" Mengambil data... ")])):M.value.length?(o(),l("ul",ht,[(o(!0),l(P,null,I(M.value,(n,$)=>(o(),l("li",{key:$,class:"list-group-item py-2 px-2",style:{"line-height":"1.4"}},[e("div",null,[e("span",ft,c(n.status),1),gt,e("span",bt,c(n.verifier_name),1),e("small",yt," pada "+c(n.verified_at),1)]),n.notes?(o(),l("div",kt,[xt,k(c(n.notes),1)])):f("",!0)]))),128))])):(o(),l("div",wt,"Tidak ada log verifikasi."))]),e("div",Dt,[x.value&&!v.value?(o(),l("iframe",{key:0,ref_key:"pdfFrame",ref:X,src:`${x.value}#toolbar=0&navpanes=0&scrollbar=0`,class:"w-100",frameborder:"0",style:{height:"70vh",border:"1px solid #ccc"},onLoad:Y,onError:Z},null,40,Ut)):(o(),l("div",Ct,[v.value?(o(),l("p",Ft,"Gagal memuat dokumen. Pastikan file tersedia dan dapat diakses. ")):(o(),l("p",St,"File tidak tersedia."))]))])])])])])])):f("",!0),L.value?(o(),l("div",Mt,[e("div",Lt,[e("div",Tt,[e("div",Pt,[e("h5",Vt,"Upload Dokumen: "+c((H=g.value)==null?void 0:H.text),1),e("button",{type:"button",class:"close",onClick:A},jt)]),e("div",$t,[e("form",{onSubmit:pe(de,["prevent"])},[e("input",{type:"hidden",value:(Q=g.value)==null?void 0:Q.id},null,8,It),e("div",Rt,[Nt,e("input",{type:"text",class:"form-control",value:(J=g.value)==null?void 0:J.text,readonly:""},null,8,zt)]),e("div",qt,[At,U(e("input",{"onUpdate:modelValue":a[2]||(a[2]=n=>d.value.doc_number=n),type:"text",class:"form-control",required:"",autofocus:""},null,512),[[T,d.value.doc_number]])]),e("div",Gt,[Ot,U(e("input",{"onUpdate:modelValue":a[3]||(a[3]=n=>d.value.doc_date=n),type:"date",class:"form-control",required:""},null,512),[[T,d.value.doc_date]])]),e("div",Et,[Ht,U(e("input",{"onUpdate:modelValue":a[4]||(a[4]=n=>d.value.parameter=n),type:"text",class:"form-control"},null,512),[[T,d.value.parameter]])]),e("div",Qt,[Jt,e("input",{onChange:ne,type:"file",class:"form-control",accept:"application/pdf",required:""},null,32)]),D.value?(o(),l("div",Kt,[e("div",Wt,[e("div",{class:V(["progress-bar progress-bar-striped progress-bar-animated",W.value]),role:"progressbar",style:ve({width:h.value+"%"}),"aria-valuenow":h.value,"aria-valuemin":"0","aria-valuemax":"100"},c(h.value)+"% ",15,Xt)])])):f("",!0),e("div",Yt,[e("button",{type:"submit",class:"btn btn-primary",disabled:D.value},[D.value?(o(),l("span",ea,[ta,k(" Uploading... ")])):(o(),l("span",aa," Upload "))],8,Zt)])],32)])])])])):f("",!0)],64)}}},da=ue(sa,[["__scopeId","data-v-95d37d37"]]);export{da as default};
